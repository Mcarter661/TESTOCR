{% extends "base.html" %}

{% block title %}Upload - MCA Underwriting Command Center{% endblock %}
{% block page_title %}Upload Bank Statements{% endblock %}

{% block content %}
<div class="upload-container">
    <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="upload-form" id="uploadForm">
        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">&#8679;</div>
            <h3>Drag & Drop PDF Files Here</h3>
            <p>or click to browse - select up to 30 files at once</p>
            <input type="file" name="files" id="fileInput" multiple accept=".pdf" class="file-input">
            <div class="file-preview" id="filePreview"></div>
        </div>
        <div class="upload-actions" id="uploadActions" style="display:none;">
            <div class="upload-summary" id="uploadSummary"></div>
            <button type="submit" class="btn btn-primary btn-large" id="uploadBtn">
                Upload Selected Files
            </button>
        </div>
    </form>
</div>

<section class="uploaded-files-section">
    <div class="section-header">
        <h3>Uploaded Files</h3>
        <span class="file-count">{{ files|length }} file(s)</span>
    </div>
    
    {% if files %}
    <table class="data-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Filename</th>
                <th>Size</th>
                <th>Uploaded</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>
                    <span class="file-icon">&#128196;</span>
                    {{ file.name }}
                </td>
                <td>{{ file.size_display }}</td>
                <td>{{ file.uploaded }}</td>
                <td>
                    <form action="{{ url_for('delete_file', filename=file.name) }}" method="post" class="inline-form">
                        <button type="submit" class="btn-sm btn-danger" onclick="return confirm('Delete this file?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="table-footer">
        <a href="{{ url_for('process') }}" class="btn btn-primary">
            Proceed to Processing
        </a>
    </div>
    {% else %}
    <div class="empty-state">
        <p>No files uploaded yet</p>
        <p class="hint">Upload PDF bank statements to get started</p>
    </div>
    {% endif %}
</section>

<script>
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const uploadActions = document.getElementById('uploadActions');
const uploadSummary = document.getElementById('uploadSummary');

uploadZone.addEventListener('click', (e) => {
    if (e.target === fileInput) return;
    fileInput.click();
});

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    fileInput.files = e.dataTransfer.files;
    updatePreview();
});

fileInput.addEventListener('change', updatePreview);

function updatePreview() {
    filePreview.innerHTML = '';
    const files = fileInput.files;
    const maxFiles = 30;
    
    if (files.length > maxFiles) {
        uploadActions.style.display = 'flex';
        uploadSummary.textContent = 'Too many files! Maximum ' + maxFiles + ' files allowed.';
        uploadSummary.style.color = '#dc2626';
        document.getElementById('uploadBtn').disabled = true;
        return;
    }
    
    if (files.length > 0) {
        uploadZone.classList.add('has-files');
        uploadActions.style.display = 'flex';
        uploadSummary.style.color = '';
        document.getElementById('uploadBtn').disabled = false;
        let totalSize = 0;
        for (let file of files) {
            totalSize += file.size;
            const div = document.createElement('div');
            div.className = 'preview-item';
            const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
            const sizeStr = file.size > 1024 * 1024 ? sizeMB + ' MB' : (file.size / 1024).toFixed(0) + ' KB';
            div.innerHTML = '<span class="file-icon">&#128196;</span> ' + file.name + ' <span class="file-size">(' + sizeStr + ')</span>';
            filePreview.appendChild(div);
        }
        const totalMB = (totalSize / (1024 * 1024)).toFixed(1);
        uploadSummary.textContent = files.length + ' file(s) selected (' + totalMB + ' MB total)';
    } else {
        uploadZone.classList.remove('has-files');
        uploadActions.style.display = 'none';
    }
}
</script>
{% endblock %}
